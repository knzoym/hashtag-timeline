// src/components/wiki/ApprovalSystem.js - Á∑®ÈõÜÊâøË™ç„Ç∑„Çπ„ÉÜ„É†
import React, { useState, useEffect, useCallback } from 'react';
import WikiRevisionDiff from './WikiRevisionDiff';

const ApprovalSystem = ({ user, wikiData }) => {
  const [pendingRevisions, setPendingRevisions] = useState([]);
  const [selectedRevision, setSelectedRevision] = useState(null);
  const [showDiff, setShowDiff] = useState(false);
  const [filterStatus, setFilterStatus] = useState('pending'); // 'pending' | 'approved' | 'rejected' | 'all'
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // ÊâøË™çÂæÖ„Å°„É™„Éì„Ç∏„Éß„É≥ÂèñÂæó
  const loadPendingRevisions = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const revisions = await wikiData.getPendingRevisions(filterStatus);
      setPendingRevisions(revisions);
      
      console.log('ÊâøË™çÂæÖ„Å°„É™„Éì„Ç∏„Éß„É≥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', revisions.length);
    } catch (err) {
      console.error('ÊâøË™çÂæÖ„Å°„É™„Éì„Ç∏„Éß„É≥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
      setError(err.message || 'ÊâøË™çÂæÖ„Å°„É™„Éì„Ç∏„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    } finally {
      setLoading(false);
    }
  }, [wikiData, filterStatus]);

  useEffect(() => {
    loadPendingRevisions();
  }, [loadPendingRevisions]);

  // ÊâøË™çÂá¶ÁêÜ
  const handleApprove = useCallback(async (revisionId) => {
    if (!user) {
      setError('ÊâøË™ç„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
      return;
    }

    if (!window.confirm('„Åì„ÅÆ„É™„Éì„Ç∏„Éß„É≥„ÇíÊâøË™ç„Åó„Å¶ÂÆâÂÆöÁâà„Å´ÂèçÊò†„Åó„Åæ„Åô„ÅãÔºü')) {
      return;
    }

    try {
      const result = await wikiData.approveRevision(revisionId);
      if (result) {
        console.log('„É™„Éì„Ç∏„Éß„É≥ÊâøË™çÂÆå‰∫Ü:', revisionId);
        await loadPendingRevisions(); // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
      }
    } catch (err) {
      console.error('ÊâøË™çÂá¶ÁêÜ„Ç®„É©„Éº:', err);
      setError(err.message || 'ÊâøË™çÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }, [user, wikiData, loadPendingRevisions]);

  // Âç¥‰∏ãÂá¶ÁêÜ
  const handleReject = useCallback(async (revisionId, reason = '') => {
    if (!user) {
      setError('Âç¥‰∏ã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
      return;
    }

    const rejectReason = reason || window.prompt('Âç¥‰∏ãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªªÊÑèÔºâÔºö');
    
    if (!window.confirm('„Åì„ÅÆ„É™„Éì„Ç∏„Éß„É≥„ÇíÂç¥‰∏ã„Åó„Åæ„Åô„ÅãÔºü')) {
      return;
    }

    try {
      const result = await wikiData.rejectRevision(revisionId, rejectReason);
      if (result) {
        console.log('„É™„Éì„Ç∏„Éß„É≥Âç¥‰∏ãÂÆå‰∫Ü:', revisionId);
        await loadPendingRevisions(); // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
      }
    } catch (err) {
      console.error('Âç¥‰∏ãÂá¶ÁêÜ„Ç®„É©„Éº:', err);
      setError(err.message || 'Âç¥‰∏ãÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }, [user, wikiData, loadPendingRevisions]);

  // „É¶„Éº„Ç∂„ÉºÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
  const getUserPermissionLevel = useCallback(() => {
    if (!user) return 'none';
    
    // TODO: ÂÆüÈöõ„ÅÆÊ®©Èôê„Ç∑„Çπ„ÉÜ„É†„ÇíÂÆüË£Ö
    // Êö´ÂÆöÁöÑ„Å´ÂÖ®„É¶„Éº„Ç∂„Éº„Å´ÊâøË™çÊ®©Èôê„Çí‰ªò‰∏é
    return 'moderator';
    
    // Â∞ÜÊù•ÁöÑ„Å™ÂÆüË£Ö‰æã:
    // if (user.role === 'admin') return 'admin';
    // if (user.reputation >= 100) return 'moderator';  
    // if (user.reputation >= 10) return 'trusted';
    // return 'basic';
  }, [user]);

  const permissionLevel = getUserPermissionLevel();
  const canApprove = permissionLevel !== 'none';

  // „É™„Éì„Ç∏„Éß„É≥Áä∂ÊÖã„ÅÆË°®Á§∫ÊÉÖÂ†±
  const getRevisionStatusInfo = (revision) => {
    const statusMap = {
      pending: { 
        icon: '‚è≥', 
        label: 'ÊâøË™çÂæÖ„Å°', 
        color: '#f59e0b',
        bgColor: '#fef3c7'
      },
      approved: { 
        icon: '‚úÖ', 
        label: 'ÊâøË™çÊ∏à„Åø', 
        color: '#10b981',
        bgColor: '#d1fae5'
      },
      rejected: { 
        icon: '‚ùå', 
        label: 'Âç¥‰∏ã', 
        color: '#ef4444',
        bgColor: '#fee2e2'
      },
      auto_approved: { 
        icon: 'ü§ñ', 
        label: 'Ëá™ÂãïÊâøË™ç', 
        color: '#8b5cf6',
        bgColor: '#ede9fe'
      }
    };

    const status = revision.approval_status || 'pending';
    return statusMap[status] || statusMap.pending;
  };

  // Ëá™ÂãïÊâøË™çÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
  const checkAutoApprovalEligibility = (revision) => {
    const upvoteThreshold = 3;
    const reportThreshold = 2;
    const scoreThreshold = 2.0;
    const timeThreshold = 24 * 60 * 60 * 1000; // 24ÊôÇÈñìÔºà„Éü„É™ÁßíÔºâ

    const upvotes = revision.upvotes || 0;
    const reports = revision.reports || 0;
    const score = revision.stable_score || 0;
    const age = new Date() - new Date(revision.created_at);

    return {
      meetsUpvoteThreshold: upvotes >= upvoteThreshold,
      meetsScoreThreshold: score >= scoreThreshold,
      hasMinimalReports: reports < reportThreshold,
      isOldEnough: age >= timeThreshold,
      isEligible: upvotes >= upvoteThreshold && 
                 score >= scoreThreshold && 
                 reports < reportThreshold && 
                 age >= timeThreshold
    };
  };

  const styles = {
    container: {
      display: 'flex',
      flexDirection: 'column',
      height: '100%',
      backgroundColor: '#f8fafc'
    },
    header: {
      padding: '20px',
      backgroundColor: 'white',
      borderBottom: '1px solid #e5e7eb'
    },
    title: {
      fontSize: '24px',
      fontWeight: '700',
      color: '#1f2937',
      marginBottom: '8px'
    },
    subtitle: {
      fontSize: '14px',
      color: '#6b7280',
      marginBottom: '16px'
    },
    filterContainer: {
      display: 'flex',
      gap: '12px',
      alignItems: 'center'
    },
    filterButton: {
      padding: '8px 16px',
      border: '1px solid #d1d5db',
      borderRadius: '6px',
      backgroundColor: 'white',
      cursor: 'pointer',
      fontSize: '14px',
      fontWeight: '500',
      transition: 'all 0.2s'
    },
    filterButtonActive: {
      backgroundColor: '#3b82f6',
      color: 'white',
      borderColor: '#3b82f6'
    },
    errorAlert: {
      backgroundColor: '#fee2e2',
      border: '1px solid #fca5a5',
      color: '#dc2626',
      padding: '12px',
      borderRadius: '6px',
      margin: '20px',
      fontSize: '14px'
    },
    content: {
      flex: 1,
      padding: '20px',
      overflow: 'auto'
    },
    loadingMessage: {
      textAlign: 'center',
      padding: '40px',
      color: '#6b7280',
      fontSize: '16px'
    },
    emptyMessage: {
      textAlign: 'center',
      padding: '40px',
      color: '#6b7280',
      fontSize: '16px',
      backgroundColor: 'white',
      borderRadius: '8px',
      border: '1px solid #e5e7eb'
    },
    revisionCard: {
      backgroundColor: 'white',
      border: '1px solid #e5e7eb',
      borderRadius: '8px',
      padding: '16px',
      marginBottom: '12px',
      transition: 'all 0.2s'
    },
    revisionHeader: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: '12px'
    },
    revisionInfo: {
      flex: 1
    },
    revisionTitle: {
      fontSize: '16px',
      fontWeight: '600',
      color: '#1f2937',
      marginBottom: '4px'
    },
    revisionMeta: {
      fontSize: '12px',
      color: '#6b7280',
      display: 'flex',
      gap: '12px',
      marginBottom: '8px'
    },
    statusBadge: {
      display: 'inline-flex',
      alignItems: 'center',
      gap: '4px',
      padding: '4px 8px',
      borderRadius: '4px',
      fontSize: '12px',
      fontWeight: '500'
    },
    revisionDescription: {
      fontSize: '14px',
      color: '#374151',
      lineHeight: '1.5',
      marginBottom: '12px'
    },
    revisionTags: {
      display: 'flex',
      flexWrap: 'wrap',
      gap: '4px',
      marginBottom: '12px'
    },
    tag: {
      backgroundColor: '#dbeafe',
      color: '#1e40af',
      padding: '2px 6px',
      borderRadius: '4px',
      fontSize: '11px'
    },
    approvalInfo: {
      padding: '12px',
      backgroundColor: '#f8fafc',
      borderRadius: '6px',
      border: '1px solid #e2e8f0',
      marginBottom: '12px'
    },
    approvalTitle: {
      fontSize: '14px',
      fontWeight: '600',
      color: '#374151',
      marginBottom: '8px'
    },
    approvalStats: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
      gap: '8px',
      fontSize: '12px'
    },
    approvalStat: {
      display: 'flex',
      justifyContent: 'space-between'
    },
    actionButtons: {
      display: 'flex',
      gap: '8px',
      flexWrap: 'wrap'
    },
    button: {
      padding: '8px 16px',
      border: 'none',
      borderRadius: '6px',
      fontSize: '14px',
      fontWeight: '500',
      cursor: 'pointer',
      transition: 'all 0.2s'
    },
    approveButton: {
      backgroundColor: '#10b981',
      color: 'white'
    },
    rejectButton: {
      backgroundColor: '#ef4444',
      color: 'white'
    },
    diffButton: {
      backgroundColor: '#6b7280',
      color: 'white'
    },
    disabledButton: {
      backgroundColor: '#d1d5db',
      color: '#9ca3af',
      cursor: 'not-allowed'
    }
  };

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h2 style={styles.title}>Á∑®ÈõÜÊâøË™çÁÆ°ÁêÜ</h2>
        <p style={styles.subtitle}>
          „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Å´„Çà„ÇãÁ∑®ÈõÜÊèêÊ°à„ÅÆÊâøË™ç„ÉªÂç¥‰∏ã„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô
        </p>

        {/* „Éï„Ç£„É´„Çø„Éº */}
        <div style={styles.filterContainer}>
          <span style={{ fontSize: '14px', color: '#374151', fontWeight: '500' }}>
            Ë°®Á§∫„Éï„Ç£„É´„Çø„ÉºÔºö
          </span>
          {['pending', 'approved', 'rejected', 'all'].map(status => (
            <button
              key={status}
              onClick={() => setFilterStatus(status)}
              style={{
                ...styles.filterButton,
                ...(filterStatus === status ? styles.filterButtonActive : {})
              }}
              onMouseEnter={(e) => {
                if (filterStatus !== status) {
                  e.target.style.backgroundColor = '#f3f4f6';
                }
              }}
              onMouseLeave={(e) => {
                if (filterStatus !== status) {
                  e.target.style.backgroundColor = 'white';
                }
              }}
            >
              {{
                pending: 'ÊâøË™çÂæÖ„Å°',
                approved: 'ÊâøË™çÊ∏à„Åø', 
                rejected: 'Âç¥‰∏ãÊ∏à„Åø',
                all: '„Åô„Åπ„Å¶'
              }[status]}
            </button>
          ))}
        </div>

        {!canApprove && (
          <div style={{
            padding: '12px',
            backgroundColor: '#fef3c7',
            borderLeft: '4px solid #f59e0b',
            marginTop: '16px'
          }}>
            <div style={{ fontSize: '14px', color: '#92400e', fontWeight: '500' }}>
              ‚ÑπÔ∏è ÊâøË™çÊ®©Èôê„Å´„Å§„ÅÑ„Å¶
            </div>
            <div style={{ fontSize: '12px', color: '#92400e', marginTop: '4px' }}>
              Á∑®ÈõÜ„ÅÆÊâøË™ç„ÉªÂç¥‰∏ã„ÇíË°å„ÅÜ„Å´„ÅØ„ÄÅ‰∏ÄÂÆö„ÅÆ‰ø°È†º„É¨„Éô„É´„ÅåÂøÖË¶Å„Åß„Åô
            </div>
          </div>
        )}
      </div>

      {/* „Ç®„É©„ÉºË°®Á§∫ */}
      {error && (
        <div style={styles.errorAlert}>
          {error}
          <button 
            onClick={() => setError(null)} 
            style={{ float: 'right', background: 'none', border: 'none', cursor: 'pointer' }}
          >
            √ó
          </button>
        </div>
      )}

      <div style={styles.content}>
        {loading ? (
          <div style={styles.loadingMessage}>
            üìã ÊâøË™çÂæÖ„Å°„É™„Éì„Ç∏„Éß„É≥„ÇíË™≠„ÅøËæº„Åø‰∏≠...
          </div>
        ) : pendingRevisions.length === 0 ? (
          <div style={styles.emptyMessage}>
            {filterStatus === 'pending' ? 
              'ÁèæÂú®ÊâøË™çÂæÖ„Å°„ÅÆ„É™„Éì„Ç∏„Éß„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì' :
              `${filterStatus}„ÅÆ„É™„Éì„Ç∏„Éß„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`
            }
          </div>
        ) : (
          <div>
            {pendingRevisions.map((revision) => {
              const statusInfo = getRevisionStatusInfo(revision);
              const autoApproval = checkAutoApprovalEligibility(revision);
              
              return (
                <div
                  key={revision.rev_id}
                  style={styles.revisionCard}
                  onMouseEnter={(e) => e.target.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)'}
                  onMouseLeave={(e) => e.target.style.boxShadow = 'none'}
                >
                  <div style={styles.revisionHeader}>
                    <div style={styles.revisionInfo}>
                      <h3 style={styles.revisionTitle}>
                        {revision.data?.title || 'ÁÑ°È°å'}
                      </h3>
                      
                      <div style={styles.revisionMeta}>
                        <span>‰ΩúÊàê: {new Date(revision.created_at).toLocaleString('ja-JP')}</span>
                        <span>Á∑®ÈõÜËÄÖ: {revision.profiles?.display_name || revision.profiles?.username || 'ÂåøÂêç'}</span>
                        <span>ÂØæË±°: {revision.event_title || '„Ç§„Éô„É≥„Éà'}</span>
                      </div>

                      <div style={{
                        ...styles.statusBadge,
                        color: statusInfo.color,
                        backgroundColor: statusInfo.bgColor
                      }}>
                        {statusInfo.icon} {statusInfo.label}
                      </div>
                    </div>
                  </div>

                  {/* Ë™¨ÊòéÊñáÔºàÁü≠Á∏ÆË°®Á§∫Ôºâ */}
                  {revision.data?.description && (
                    <div style={styles.revisionDescription}>
                      {revision.data.description.length > 150 
                        ? revision.data.description.substring(0, 150) + '...'
                        : revision.data.description
                      }
                    </div>
                  )}

                  {/* „Çø„Ç∞ */}
                  {revision.data?.tags && revision.data.tags.length > 0 && (
                    <div style={styles.revisionTags}>
                      {revision.data.tags.slice(0, 5).map((tag, index) => (
                        <span key={index} style={styles.tag}>
                          #{tag}
                        </span>
                      ))}
                      {revision.data.tags.length > 5 && (
                        <span style={{ fontSize: '12px', color: '#6b7280' }}>
                          +{revision.data.tags.length - 5}ÂÄã
                        </span>
                      )}
                    </div>
                  )}

                  {/* ÊâøË™çÊÉÖÂ†± */}
                  <div style={styles.approvalInfo}>
                    <div style={styles.approvalTitle}>ÊâøË™çÁä∂Ê≥Å</div>
                    <div style={styles.approvalStats}>
                      <div style={styles.approvalStat}>
                        <span>üëç „ÅÑ„ÅÑ„Å≠:</span>
                        <span style={{ fontWeight: '600' }}>{revision.upvotes || 0}</span>
                      </div>
                      <div style={styles.approvalStat}>
                        <span>‚ö†Ô∏è ÂïèÈ°åÂ†±Âëä:</span>
                        <span style={{ fontWeight: '600' }}>{revision.reports || 0}</span>
                      </div>
                      <div style={styles.approvalStat}>
                        <span>üìä „Çπ„Ç≥„Ç¢:</span>
                        <span style={{ fontWeight: '600' }}>{revision.stable_score?.toFixed(1) || '0.0'}</span>
                      </div>
                      <div style={styles.approvalStat}>
                        <span>‚è∞ ÁµåÈÅéÊôÇÈñì:</span>
                        <span style={{ fontWeight: '600' }}>
                          {Math.floor((new Date() - new Date(revision.created_at)) / (1000 * 60 * 60))}ÊôÇÈñì
                        </span>
                      </div>
                    </div>

                    {/* Ëá™ÂãïÊâøË™çÊù°‰ª∂Ë°®Á§∫ */}
                    {revision.approval_status === 'pending' && (
                      <div style={{ marginTop: '8px' }}>
                        <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>
                          Ëá™ÂãïÊâøË™çÊù°‰ª∂:
                        </div>
                        <div style={{ display: 'flex', gap: '12px', fontSize: '11px' }}>
                          <span style={{ color: autoApproval.meetsUpvoteThreshold ? '#10b981' : '#6b7280' }}>
                            {autoApproval.meetsUpvoteThreshold ? '‚úì' : '‚óã'} „ÅÑ„ÅÑ„Å≠3‰ª•‰∏ä
                          </span>
                          <span style={{ color: autoApproval.meetsScoreThreshold ? '#10b981' : '#6b7280' }}>
                            {autoApproval.meetsScoreThreshold ? '‚úì' : '‚óã'} „Çπ„Ç≥„Ç¢2.0‰ª•‰∏ä
                          </span>
                          <span style={{ color: autoApproval.hasMinimalReports ? '#10b981' : '#6b7280' }}>
                            {autoApproval.hasMinimalReports ? '‚úì' : '‚óã'} ÂïèÈ°åÂ†±Âëä2Êú™Ê∫Ä
                          </span>
                          <span style={{ color: autoApproval.isOldEnough ? '#10b981' : '#6b7280' }}>
                            {autoApproval.isOldEnough ? '‚úì' : '‚óã'} 24ÊôÇÈñìÁµåÈÅé
                          </span>
                        </div>
                        
                        {autoApproval.isEligible && (
                          <div style={{
                            marginTop: '8px',
                            padding: '6px 10px',
                            backgroundColor: '#d1fae5',
                            color: '#166534',
                            borderRadius: '4px',
                            fontSize: '12px',
                            fontWeight: '500'
                          }}>
                            ü§ñ Ëá™ÂãïÊâøË™ç„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åô
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
                  <div style={styles.actionButtons}>
                    <button
                      onClick={() => {
                        setSelectedRevision(revision);
                        setShowDiff(true);
                      }}
                      style={{ ...styles.button, ...styles.diffButton }}
                      onMouseEnter={(e) => e.target.style.backgroundColor = '#4b5563'}
                      onMouseLeave={(e) => e.target.style.backgroundColor = '#6b7280'}
                    >
                      üìÑ Â∑ÆÂàÜË°®Á§∫
                    </button>

                    {canApprove && revision.approval_status === 'pending' && (
                      <>
                        <button
                          onClick={() => handleApprove(revision.rev_id)}
                          style={{ ...styles.button, ...styles.approveButton }}
                          onMouseEnter={(e) => e.target.style.backgroundColor = '#059669'}
                          onMouseLeave={(e) => e.target.style.backgroundColor = '#10b981'}
                        >
                          ‚úÖ ÊâøË™ç
                        </button>
                        
                        <button
                          onClick={() => handleReject(revision.rev_id)}
                          style={{ ...styles.button, ...styles.rejectButton }}
                          onMouseEnter={(e) => e.target.style.backgroundColor = '#dc2626'}
                          onMouseLeave={(e) => e.target.style.backgroundColor = '#ef4444'}
                        >
                          ‚ùå Âç¥‰∏ã
                        </button>
                      </>
                    )}

                    {!canApprove && (
                      <span style={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                        ÊâøË™çÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô
                      </span>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* Â∑ÆÂàÜË°®Á§∫„É¢„Éº„ÉÄ„É´ */}
      {showDiff && selectedRevision && (
        <WikiRevisionDiff
          baseRevision={selectedRevision.stable_data || {}}
          compareRevision={selectedRevision.data || selectedRevision}
          onClose={() => {
            setShowDiff(false);
            setSelectedRevision(null);
          }}
        />
      )}
    </div>
  );
};

export default ApprovalSystem;